name: Daily Notification Sender

# üïê Ejecutar autom√°ticamente todos los d√≠as a las 9:00 AM (UTC-6 = 3:00 PM UTC)
# Para horario de M√©xico (UTC-6), 9 AM = 15:00 UTC
on:
  schedule:
    # Ejecutar a las 15:00 UTC (9:00 AM Mexico City Time)
    - cron: '0 15 * * *'
  
  # Permitir ejecuci√≥n manual desde GitHub Actions UI
  workflow_dispatch:

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: üìß Call notification processing endpoint
        run: |
          echo "üîÑ Starting automated notification processing..."
          
          # Llamar al endpoint de procesamiento de notificaciones (POST)
          # IMPORTANTE: Supabase requiere el header Authorization incluso para endpoints p√∫blicos
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1cWZpdmN0dmZvYnd4aXFtYnV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA0MTMyODMsImV4cCI6MjA0NTk4OTI4M30.SaNNtPeqt_hLJAjuqjhxWOe3r2XW-1yMfI1Gp-gFV-0" \
            -H "Content-Type: application/json" \
            https://buqfivctvfobwxiqmbut.supabase.co/functions/v1/make-server-8fc06582/process-notifications)
          
          # Separar el cuerpo de la respuesta del c√≥digo HTTP
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "üìä Response Code: $http_code"
          echo "üìÑ Response Body: $body"
          
          # Verificar si fue exitoso
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Notifications processed successfully!"
            
            # Parsear y mostrar estad√≠sticas
            sent_count=$(echo "$body" | grep -o '"sentCount":[0-9]*' | grep -o '[0-9]*')
            skipped_count=$(echo "$body" | grep -o '"skippedCount":[0-9]*' | grep -o '[0-9]*')
            error_count=$(echo "$body" | grep -o '"errorCount":[0-9]*' | grep -o '[0-9]*')
            
            echo "üìä Statistics:"
            echo "  ‚úâÔ∏è  Sent: $sent_count"
            echo "  ‚è≠Ô∏è  Skipped: $skipped_count"
            echo "  ‚ùå Errors: $error_count"
          else
            echo "‚ùå Failed to process notifications"
            exit 1
          fi
      - name: üìù Log completion
        if: always()
        run: |
          echo "‚è∞ Notification processing job completed at $(date)"
