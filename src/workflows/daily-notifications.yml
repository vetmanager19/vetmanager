name: Daily Notification Sender

# ğŸ• Ejecutar automÃ¡ticamente todos los dÃ­as a las 9:00 AM (UTC-6 = 3:00 PM UTC)
# Para horario de MÃ©xico (UTC-6), 9 AM = 15:00 UTC
on:
  schedule:
    # Ejecutar a las 15:00 UTC (9:00 AM Mexico City Time)
    - cron: '0 15 * * *'
  
  # Permitir ejecuciÃ³n manual desde GitHub Actions UI
  workflow_dispatch:

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“§ Call notification processing endpoint
        run: |
          echo "ğŸ”„ Starting automated notification processing..."
          
          # Llamar al endpoint de procesamiento de notificaciones (POST)
          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://buqfivctvfobwxiqmbut.supabase.co/functions/v1/make-server-8fc06582/process-notifications)
          
          # Separar el cuerpo de la respuesta del cÃ³digo HTTP
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "ğŸ“Š Response Code: $http_code"
          echo "ğŸ“„ Response Body: $body"
          
          # Verificar si fue exitoso
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Notifications processed successfully!"
            
            # Parsear y mostrar estadÃ­sticas
            sent_count=$(echo "$body" | grep -o '"sentCount":[0-9]*' | grep -o '[0-9]*')
            skipped_count=$(echo "$body" | grep -o '"skippedCount":[0-9]*' | grep -o '[0-9]*')
            error_count=$(echo "$body" | grep -o '"errorCount":[0-9]*' | grep -o '[0-9]*')
            
            echo "ğŸ“Š Statistics:"
            echo "  âœ‰ï¸  Sent: $sent_count"
            echo "  â­ï¸  Skipped: $skipped_count"
            echo "  âŒ Errors: $error_count"
          else
            echo "âŒ Failed to process notifications"
            exit 1
          fi

      - name: ğŸ“ Log completion
        if: always()
        run: |
          echo "â° Notification processing job completed at $(date)"
